{% extends "base.html" %}
{% block title %}List vulnerability{% endblock %}
{% block content %}
<h2>Vulnerabilities for {{ pentest_task.name }}</h2>
<a href="{% url 'pentest_task:add_vulnerability' pentest_task.id %}" class="btn btn-primary">Add Vulnerability</a>
<a href="{% url 'pentest_task:export_pentest_report' pentest_task.id %}" class="btn btn-success">
    📄 Export Report
</a>
<a href="{% url 'pentest_task:export_details_vulnerability_excel' pentest_task.id %}" class="btn btn-secondary">
    📄 Export Vulnerability Details
</a>

<h4>Risk Summary</h4>

<table class="table table-bordered text-center">
    <thead>
        <tr>
            <th class="Summary">Summary</th>
            <th class="Summary">Total</th>
            <th class="critical">Critical</th>
            <th class="high">High</th>
            <th class="medium">Medium</th>
            <th class="low">Low</th>
            <th class="recommend">Recommend</th>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td> Vulnerability 
            </td> 
            <td>{{risk_summary.Critical|default:0|add:risk_summary.High|default:0|add:risk_summary.Medium|default:0|add:risk_summary.Low|default:0|add:risk_summary.Recommend|default:0 }}</td>
            <td class="critical">{{ risk_summary.Critical|default:0 }}</td>
            <td class="high">{{ risk_summary.High|default:0 }}</td>
            <td class="medium">{{ risk_summary.Medium|default:0 }}</td>
            <td class="low">{{ risk_summary.Low|default:0 }}</td>
            <td class="recommend">{{ risk_summary.Recommend|default:0 }}</td>
        </tr>
        <tr>
            <td> API </td>
            <td>{{risk_summary_api.Critical|default:0|add:risk_summary_api.High|default:0|add:risk_summary_api.Medium|default:0|add:risk_summary_api.Low|default:0|add:risk_summary_api.Recommend|default:0 }}</td>
            <td class="critical">{{ risk_summary_api.Critical|default:0 }}</td>
            <td class="high">{{ risk_summary_api.High|default:0 }}</td>
            <td class="medium">{{ risk_summary_api.Medium|default:0 }}</td>
            <td class="low">{{ risk_summary_api.Low|default:0 }}</td>
            <td class="recommend">{{ risk_summary_api.Recommend|default:0 }}</td>
        </tr>
    </tbody>
</table>




<table class="table table-bordered mt-3">
    <thead>
        <tr>
            <th>REF</th>
            <th>Name</th>
            <th>Risk Score</th>
            <th>Risk Rating</th>
            <th>API count</th>
            <th>Status</th>
            <th>Notify Date</th>
            <th>Actions</th>
        </tr>
    </thead>
    <tbody>
        {% for vulnerability in vulnerabilities %}
        <tr>
            <td>{{ vulnerability.ref }}</td>
            <td>{{ vulnerability.name_vuln }}</td>
            <td>
                <span class="badge 
                    {% if vulnerability.risk_rating == 'Critical' %} critical_text
                    {% elif vulnerability.risk_rating == 'High' %} high_text
                    {% elif vulnerability.risk_rating == 'Medium' %} medium_text
                    {% elif vulnerability.risk_rating == 'Low' %} low_text
                    {% elif vulnerability.risk_rating == 'Recommend' %} recommend_text
                    {% else %} badge-secondary {% endif %}">
                    {{ vulnerability.risk_score }}
                </span>
            </td>
            <td>
            <span class="badge 
                {% if vulnerability.risk_rating == 'Critical' %} critical_text
                {% elif vulnerability.risk_rating == 'High' %} high_text
                {% elif vulnerability.risk_rating == 'Medium' %} medium_text
                {% elif vulnerability.risk_rating == 'Low' %} low_text
                {% elif vulnerability.risk_rating == 'Recommend' %} recommend_text
                {% else %} badge-secondary {% endif %}">
                {{ vulnerability.risk_rating }}
            </span>
            </td>
                <td>{{ vulnerability.api_count }}</td>
            <td>
                <span class="badge {% if vulnerability.status == 'Open' %}badge-danger
                                     {% elif vulnerability.status == 'Verified' %}badge-warning
                                     {% elif vulnerability.status == 'Closed' %}badge-success
                                     {% else %}badge-secondary{% endif %}">
                    {{ vulnerability.status }}
                </span>
            
            <td>{{vulnerability.notify_date}}</td>
                <!-- {% if vulnerability.status == "Verified" %}
                    <span class="badge bg-warning">{{ vulnerability.status }}</span>
                {% elif vulnerability.status == "Open" %}
                    <span class="badge bg-danger">{{ vulnerability.status }}</span>
                {% elif vulnerability.status == "Closed" %}
                    <span class="badge bg-success">{{ vulnerability.status }}</span>
                {% else %}
                    <span class="badge bg-secondary">{{ task.status }}</span>
                {% endif %} -->
            </td>
            <td>
                <a href="{% url 'pentest_task:view_vulnerability' pentest_task.id vulnerability.id %}" class="text-primary">👁️View</a>
                <a href="{% url 'pentest_task:edit_vulnerability' pentest_task.id vulnerability.id %}" class="text-primary btn-sm">✏️ Edit</a>
                <form action="{% url 'pentest_task:delete_vulnerability' pentest_task.id vulnerability.id %}" method="POST" style="display:inline;">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-danger" onclick="return confirm('Are you sure you want to delete this vulnerability?');">Delete</button>
                </form>

            </td>
            
        </tr>
        {% empty %}
        <tr>
            <td colspan="5" class="text-center">No vulnerabilities found.</td>
        </tr>
        {% endfor %}
    </tbody>
</table>
<a href="{% url 'pentest_task:list_pentest_tasks' %}" class="btn btn-secondary">Back to Tasks</a>
<h4>Export Report History</h4>
<div style="max-height: 200px; overflow-y: auto; border: 1px solid #dee2e6; border-radius: 5px;">
  <table class="table table-sm table-bordered mb-0">
    <thead class="table-light sticky-top bg-light">
      <tr>
        <th>Time</th>
        <th>User</th>
      </tr>
    </thead>
    <tbody>
      {% for log in export_logs %}
        <tr>
          <td>{{ log.export_time|date:"d-m-Y H:i" }}</td>
          <td>{{ log.user }}</td>
        </tr>
      {% empty %}
        <tr>
          <td colspan="2"><em>Chưa có lần export nào.</em></td>
        </tr>
      {% endfor %}
    </tbody>
  </table>
</div>


{% endblock %}
