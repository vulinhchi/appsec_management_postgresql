<form method="post" enctype="multipart/form-data">
    {% csrf_token %}
    
    <!-- Các form hiện tại -->
    <div id="formset-body">
        {% for form in formset %}
            <table>
                <tbody>
                    <tr class="form-row" id="form-row-{{ forloop.counter }}">
                        <td>{{ form.vuln_api }}</td>
                        <td>{{ form.request }}</td>
                        <td>{{ form.response }}</td>
                        <td>{{ form.note }}</td>
                        <td>{{ form.poc }}</td>
                        <td>
                            <button type="button" class="btn btn-danger remove-form-btn">Xóa</button>
                        </td>
                    </tr>
                </tbody>
            </table>
        {% endfor %}
    </div>
    
    <!-- Hidden input để Django quản lý số lượng form -->
    <input type="hidden" name="affected_urls-TOTAL_FORMS" value="{{ formset.total_form_count }}" id="id_form-TOTAL_FORMS">
    <input type="hidden" name="affected_urls-INITIAL_FORMS" value="{{ formset.initial_form_count }}" id="id_form-INITIAL_FORMS">
    
    <!-- Button để thêm form mới -->
    <button type="button" id="add-form-btn" class="btn btn-primary">Thêm Affected URL</button>
    
    <!-- Template cho form mới (ẩn khi không sử dụng) -->
    <div id="empty-form-template" style="display: none;">
    <table>
        <tbody>
            <tr class="form-row" id="form-row-__prefix__">
                <td>
                    <textarea name="affected_urls-__prefix__-vuln_api" cols="40" rows="10" class="form-control"
                        placeholder="Affected API (for example:GET /api/v1/user/info)"></textarea>
                </td>
                <td>
                    <textarea name="affected_urls-__prefix__-request" cols="40" rows="10" class="form-control"
                        placeholder="Request in raw HTTP"></textarea>
                </td>
                <td>
                    <textarea name="affected_urls-__prefix__-response" cols="40" rows="10" class="form-control"
                        placeholder="Response in HTTP"></textarea>
                </td>
                <td>
                    <textarea name="affected_urls-__prefix__-note" cols="40" rows="10" class="form-control"
                        placeholder="Note, details"></textarea>
                </td>
                <td>
                    <textarea name="affected_urls-__prefix__-poc" cols="40" rows="10" class="form-control"
                        placeholder="POC"></textarea>
                </td>
                <td>
                    <button type="button" class="btn btn-danger remove-form-btn">Xóa</button>
                </td>
            </tr>
        </tbody>
    </table>
</div>

    
    <!-- Submit button -->
    <button type="submit" class="btn btn-success">Lưu</button>
</form>

<script>
document.addEventListener("DOMContentLoaded", function () {
    const addBtn = document.getElementById("add-form-btn");
    const formsetBody = document.getElementById("formset-body");
    const totalForms = document.getElementById("id_form-TOTAL_FORMS");
    const emptyFormRow = document.querySelector("#empty-form-template .form-row");

    if (!totalForms) {
        console.error('Không tìm thấy phần tử totalForms!');
        return;
    }

    addBtn.addEventListener("click", function () {
        const formCount = parseInt(totalForms.value);
        const newRow = emptyFormRow.cloneNode(true);

        // Thay thế __prefix__ bằng formCount
        newRow.innerHTML = newRow.innerHTML.replace(/__prefix__/g, formCount);
        
        // Thêm form mới vào formset-body
        formsetBody.appendChild(newRow);

        // Cập nhật lại giá trị của totalForms
        totalForms.value = formCount + 1;
    });

    // Lắng nghe sự kiện "Xóa" cho mỗi dòng form
    formsetBody.addEventListener("click", function(event) {
        if (event.target && event.target.classList.contains("remove-form-btn")) {
            const row = event.target.closest(".form-row");

            // Kiểm tra xem dòng này là form đã lưu hay chưa
            if (row.querySelector("input[type='hidden']")) {
                // Đánh dấu dòng này là sẽ xóa khi submit
                row.querySelector("input[type='hidden']").value = "DELETE";
            } else {
                // Nếu là form mới, xóa nó trực tiếp khỏi DOM
                row.remove();
            }

            // Cập nhật lại lại totalForms sau khi xóa
            const formCount = parseInt(totalForms.value);
            totalForms.value = formCount - 1;
        }
    });
});
</script>
