<nav class="navbar navbar-expand-lg navbar-light bg-light">
  <div class="container-fluid">
    <!-- ƒê·∫∑t ph·∫ßn hi·ªÉn th·ªã t√™n ng∆∞·ªùi d√πng v√† logout ·ªü g√≥c ph·∫£i -->
    <div class="ml-auto">
      {% if user.is_authenticated %}
        <span class="navbar-text mr-3">Hello, {{ user.username }}!</span> <!-- Hi·ªÉn th·ªã t√™n ng∆∞·ªùi d√πng -->
        <a href="{% url 'logout' %}" class="btn btn-outline-danger btn-sm">Logout</a> <!-- N√∫t logout -->
      {% else %}
        <a href="{% url 'login' %}" class="btn btn-outline-primary btn-sm">Login</a> <!-- N√∫t login n·∫øu ch∆∞a ƒëƒÉng nh·∫≠p -->
      {% endif %}
    </div>
        {% csrf_token %}
        <a class="nav-link" href="#" id="notificationBell" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">

            <i class="far fa-bell"></i>
            <span id="notification_count" class="badge badge-danger navbar-badge" style="display: none;"></span>

        </a>
        <div class="dropdown-menu dropdown-menu-lg dropdown-menu-right" id="notificationDropdown">
            <span class="dropdown-item">Loading...</span>
        </div>
    
  </div>
</nav>
 
<style type="text/css">
#notificationDropdown {
    max-height: 300px;  /* Chi·ªÅu cao t·ªëi ƒëa */
    overflow-y: auto;   /* Cho ph√©p cu·ªôn d·ªçc */
    overflow-x: hidden; /* Kh√¥ng cho ph√©p cu·ªôn ngang */

}
#notification_count {
    font-size: 12px;               /* K√≠ch th∆∞·ªõc ch·ªØ */
    padding: 2px 6px;              /* ƒê·ªám nh·ªè h∆°n ƒë·ªÉ badge g·ªçn g√†ng h∆°n */
    border-radius: 50%;            /* L√†m cho badge th√†nh h√¨nh tr√≤n */
    position: absolute;            /* V·ªã tr√≠ tuy·ªát ƒë·ªëi so v·ªõi ph·∫ßn t·ª≠ cha */
    top: 15px;                      /* ƒê∆∞a l√™n m·ªôt ch√∫t ƒë·ªÉ s√°t chu√¥ng */
    right: 15px;                    /* ƒê∆∞a sang b√™n ph·∫£i s√°t chu√¥ng */
    background-color: red;         /* M√†u n·ªÅn cho badge */
    color: white;                  /* M√†u ch·ªØ c·ªßa badge */
    font-weight: bold;             /* L√†m ch·ªØ ƒë·∫≠m ƒë·ªÉ n·ªïi b·∫≠t */
}


</style>

<script>
// c√≥ g·ªçi mark_notification_as_read nh∆∞ng k g√°n is_read=true ƒë∆∞·ª£c
document.addEventListener('DOMContentLoaded', function() {
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

    // Fetch th√¥ng tin th√¥ng b√°o ngay khi trang load
    function fetchNotifications() {
        fetch("/pentest/get_notifications/", {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            }
        })
        .then(response => response.json())
        .then(data => {
            const { notifications, unread_notis_count } = data;

            // C·∫≠p nh·∫≠t s·ªë l∆∞·ª£ng th√¥ng b√°o ch∆∞a ƒë·ªçc
            const notificationCountElement = document.getElementById('notification_count');
            
            // N·∫øu c√≥ th√¥ng b√°o m·ªõi
            if (unread_notis_count > 0) {
                notificationCountElement.textContent = unread_notis_count;  // Hi·ªÉn th·ªã s·ªë l∆∞·ª£ng th√¥ng b√°o
                notificationCountElement.style.display = 'inline-block'; // Hi·ªÉn th·ªã badge
            } else {
                notificationCountElement.style.display = 'none';  // ·∫®n n·∫øu kh√¥ng c√≥ th√¥ng b√°o m·ªõi
            }

            // C·∫≠p nh·∫≠t danh s√°ch th√¥ng b√°o trong dropdown
            const dropdownMenu = document.getElementById('notificationDropdown');
            dropdownMenu.innerHTML = ''; // Clear "Loading..." text

            if (notifications.length > 0) {
                notifications.forEach(notif => {
                    const notifItem = document.createElement('a');
                    // N·∫øu ƒë√£ ƒë·ªçc th√¨ l√†m cho m·ªù h∆°n
                    if (notif.is_read) {
                        notifItem.classList.add('text-muted');  // üëà th√™m class m·ªù
                    }
                    notifItem.href = notif.url ? notif.url : '#';
                    notifItem.classList.add('dropdown-item');
                    notifItem.innerHTML = `
                        <i class="fas fa-envelope mr-2"></i> ${notif.title}
                        <span class="float-right text-muted text-sm">${notif.created_at_vn}</span>
                        <p class="dropdown-item-description">${notif.description}</p>
                    `;
                   
                    // G·∫Øn s·ª± ki·ªán click ƒë·ªÉ ƒë√°nh d·∫•u th√¥ng b√°o l√† ƒë√£ ƒë·ªçc
                    notifItem.addEventListener('click', function(event) {
                        event.preventDefault();
                        
                        fetch(`/pentest/mark_notification_as_read/${notif.id}/`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-CSRFToken': csrfToken
                            },
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (notif.url) {
                                window.location.href = notif.url;  // üëà chuy·ªÉn trang sau khi ƒë√°nh d·∫•u ƒë√£ ƒë·ªçc
                            }
                        })
                        .catch(error => {
                            console.error('Error marking notification as read:', error);
                            if (notif.url) {
                                window.location.href = notif.url; 
                            }
                        });
                    });
                    

                    dropdownMenu.appendChild(notifItem);
                });
            } else {
                dropdownMenu.innerHTML = '<span class="dropdown-item">No notifications yet</span>';
            }
        })
        .catch(error => {
            console.error('Error fetching notifications:', error);
        });
    }

    // L·∫Øng nghe s·ª± ki·ªán click v√†o chu√¥ng
    const notificationBell = document.getElementById('notificationBell');
    const dropdownMenu = document.getElementById('notificationDropdown');

    // Toggle dropdown khi click v√†o chu√¥ng
    notificationBell.addEventListener('click', function(event) {
        event.preventDefault();  // NgƒÉn vi·ªác reload trang

        // M·ªói l·∫ßn click v√†o chu√¥ng s·∫Ω l√†m m·ªõi th√¥ng b√°o
        fetchNotifications();

        // Ki·ªÉm tra xem dropdown c√≥ ƒëang m·ªü kh√¥ng
        if (dropdownMenu.classList.contains('show')) {
            dropdownMenu.classList.remove('show'); // T·∫Øt dropdown n·∫øu ƒë√£ m·ªü
        } else {
            dropdownMenu.classList.add('show'); // M·ªü dropdown n·∫øu ch∆∞a m·ªü
        }
    });

    // Khi click ra ngo√†i chu√¥ng, ·∫©n dropdown
    document.addEventListener('click', function(event) {
        const isClickInsideBell = notificationBell.contains(event.target);
        const isClickInsideDropdown = dropdownMenu.contains(event.target);

        // N·∫øu click v√†o ngo√†i chu√¥ng v√† dropdown, ·∫©n dropdown
        if (!isClickInsideBell && !isClickInsideDropdown) {
            dropdownMenu.classList.remove('show');
        }
    });

    // L·∫•y th√¥ng b√°o ngay t·ª´ ƒë·∫ßu khi trang load
    fetchNotifications();
});

</script>

