<!-- CVSS 3.1 Risk Score Calculator for AdminLTE -->
<div class="card">
    <div class="card-footer">
        <h4>Risk Score: <span id="risk-score" class="text-danger">-</span></h4>
        <h4>Risk Rating: <span id="risk-rating" class="text-warning">-</span></h4>
        <h4>CVSS Vector: <span id="risk-vector" class="text-info">-</span></h4>
        <h4>AV: <span id="risk-av" class="text-danger">-</span></h4>
        <h4>AC: <span id="risk-ac" class="text-warning">-</span></h4>
        <h4>PR: <span id="risk-pr" class="text-info">-</span></h4>
        <h4>UI: <span id="risk-ui" class="text-info">-</span></h4>
    </div>
    <div class="card-header">
        <h3 class="card-title">CVSS 3.1 Risk Assessment</h3>
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-6">
                <div class="form-group">
                    <label>Attack Vector (AV)</label>
                    <select class="form-control" id="attack-vector" name='risk_av'>
                        <option value="N">Network (N)</option>
                        <option value="A">Adjacent (A)</option>
                        <option value="L">Local (L)</option>
                        <option value="P">Physical (P)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Attack Complexity (AC)</label>
                    <select class="form-control" id="attack-complexity"name='risk_ac'>
                        <option value="L">Low (L)</option>
                        <option value="H">High (H)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Privileges Required (PR)</label>
                    <select class="form-control" id="privileges-required" name='risk_pr'>
                        <option value="N">None (N)</option>
                        <option value="L">Low (L)</option>
                        <option value="H">High (H)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>User Interaction (UI)</label>
                    <select class="form-control" id="user-interaction" name='risk_ui'>
                        <option value="N">None (N)</option>
                        <option value="R">Required (R)</option>
                    </select>
                </div>
            </div>
            <div class="col-md-6">
                <div class="form-group">
                    <label>Scope (S)</label>
                    <select class="form-control" id="scope">
                        <option value="U">Unchanged (U)</option>
                        <option value="C">Changed (C)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Confidentiality Impact (C)</label>
                    <select class="form-control" id="confidentiality-impact">
                        <option value="H">High (H)</option>
                        <option value="L">Low (L)</option>
                        <option value="N">None (N)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Integrity Impact (I)</label>
                    <select class="form-control" id="integrity-impact">
                        <option value="H">High (H)</option>
                        <option value="L">Low (L)</option>
                        <option value="N">None (N)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Availability Impact (A)</label>
                    <select class="form-control" id="availability-impact">
                        <option value="H">High (H)</option>
                        <option value="L">Low (L)</option>
                        <option value="N">None (N)</option>
                    </select>
                </div>
            </div>
        </div>
        <button type="button" class="btn btn-primary mt-3" onclick="calculateCVSS()">Calculate Risk Score</button>
    </div>
    
</div>



<script>
    function calculateCVSS() {
    const exploitabilityCoefficient = 8.22;
    const scopeCoefficient = 1.08;

    const AV = { N: 0.85, A: 0.62, L: 0.55, P: 0.2 };
    const AC = { H: 0.44, L: 0.77 };
    const PR = { U: { N: 0.85, L: 0.62, H: 0.27 }, C: { N: 0.85, L: 0.68, H: 0.5 } };
    const UI = { N: 0.85, R: 0.62 };
    const S = { U: 6.42, C: 7.52 };
    const CIA = { N: 0, L: 0.22, H: 0.56 };

    let av = $('#attack-vector').val();
    let ac = $('#attack-complexity').val();
    let pr = $('#privileges-required').val();
    let ui = $('#user-interaction').val();
    let s = $('#scope').val();
    let c = $('#confidentiality-impact').val();
    let i = $('#integrity-impact').val();
    let a = $('#availability-impact').val();

    $('#id_risk_av').val(av);
    $('#id_risk_ac').val(ac);
    $('#id_risk_pr').val(pr);
    $('#id_risk_ui').val(ui);
    $("#risk-av").text(av);
    $("#risk-ac").text(ac);
    $("#risk-pr").text(pr);
    $("#risk-ui").text(ui);

    let impactSubScoreMultiplier = (1 - ((1 - CIA[c]) * (1 - CIA[i]) * (1 - CIA[a])));
    let impactSubScore;
    if (s === 'U') {
        impactSubScore = S[s] * impactSubScoreMultiplier;
    } else {
        impactSubScore = S[s] * (impactSubScoreMultiplier - 0.029) - (3.25 * Math.pow(impactSubScoreMultiplier - 0.02, 15));
    }

    let exploitability = exploitabilityCoefficient * AV[av] * AC[ac] * PR[s][pr] * UI[ui];
    let baseScore;
    
    if (impactSubScore <= 0) {
        baseScore = 0;
    } else {
        if (s === 'U') {
            baseScore = Math.min((impactSubScore + exploitability), 10);
        } else {
            baseScore = Math.min((impactSubScore + exploitability) * scopeCoefficient, 10);
        }
    }

    function roundUp1(value) {
        return Math.ceil(value * 10) / 10;
    }
    baseScore = roundUp1(baseScore);

    // baseScore = Math.round(baseScore * 10) / 10;

    let rating = baseScore >= 9 ? "Critical" :
                 baseScore >= 7 ? "High" :
                 baseScore >= 4 ? "Medium" : "Low";

    let vector = `CVSS:3.1/AV:${av}/AC:${ac}/PR:${pr}/UI:${ui}/S:${s}/C:${c}/I:${i}/A:${a}`;

    $("#risk-score").text(baseScore);
    $("#risk-rating").text(rating).removeClass("text-danger text-warning text-success")
        .addClass(rating === "High" || rating === "Critical" ? "text-danger" : rating === "Medium" ? "text-warning" : "text-success");
    $("#cvss-vector").text(vector);

    $('#id_risk_score').val(baseScore);
    $('#id_risk_rating').val(rating);
    $('#id_risk_vector').val(vector);
}

</script>

